
task build {
  onlyIf { !file('_build').exists() }
  doLast {
    def buildDir = '_build/x86_64-unknown-linux-gnu/debug'
    mkdir buildDir

    def dockerFile = new File(buildDir + '/Dockerfile')
    dockerFile.write '''\
      FROM ockam/builder_c
      WORKDIR /work
    '''.stripIndent()

    exec {
      commandLine 'docker', 'rmi', 'ockam/implementations/c'
    }
    exec {
      workingDir buildDir
      commandLine 'docker', 'build', '-t', 'ockam/implementations/c', '.'
    }

    exec {
      commandLine 'docker', 'run', '--rm', '--volume', "${projectDir}:/work", 'ockam/implementations/c', 'bash', '-c', '''
        set -e;
        cd _build/x86_64-unknown-linux-gnu/debug;
        cmake -DCMAKE_BUILD_TYPE=Debug -DOCKAM_BUILD_TESTS=ON -DOCKAM_TARGET_PLATFORM="linux" ../../..;
        cmake --build .;
      '''
    }
  }
}

task test {
  dependsOn build
  doLast {
  }
}

task clean {
  doLast {
    delete '_build'
  }
}
